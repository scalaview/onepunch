<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>yiweixin</title>
  <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/main.css">

  <script data-main="/javascript/main" src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script data-main="/javascript/main" src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

</head>
<body>
  <div class="content">
      <div class="form-group">
          <div class="tel-name">请先绑定手机号码：</div>
          <div class="tel-input">
              <input id="phone" name='phone' type="text" class="form-control" placeholder="请填写手机号码">
          </div>
          <div class="correct" style="display: none;"></div>
      </div>
      <div class="form-group">
          <div class="col-md-4 tel-input">
              <input id="code" name='code' type="text" class="form-control" placeholder="请输入验证码">
          </div>

          <div class="col-md-4" style="float: right;">
              <div class="btn-code"><a href="javascript:void();" id="get_code">获取验证码</a></div>
          </div>
          <div class="clear"></div>
      </div>
      <div class="ml">
          <div class="inform">
              <p>我已阅读并同意<a href="Agreement.html" class="orange">《易流量用户协议》</a></p>
              <button type="button" id="submit-btn" class="btn-submit" >立即绑定</button>
          </div>
      </div>
  </div>
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="my_title">Notice</h4>
            </div>
            <div id="popup_message" class="modal-body">

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
  </div>
</body>
<script type="text/javascript">
function phoneValidateTip(){
  var $modal = $("#myModal"),
      $title = $("#my_title"),
      $msg = $("#popup_message")

  $title.html("易流量提醒")
  $msg.html('请输入正确的手机号码')
  $modal.modal('show')
}

function validatePhone(phone){
  if(phone === undefined || phone === ''){
    return true
  }else {
    return false
  }
}

function showDialog(msg){
  var $modal = $("#myModal"),
      $title = $("#my_title"),
      $msg = $("#popup_message")

  $title.html("易流量提醒")
  $msg.html(msg)
  $modal.modal('show')
}

function sendMsgSuccess(){
  showDialog('验证码已经发送成功，请注意查收')
}

function sendMsgFail(){
  showDialog('验证码发送失败')
}

function codeEmptyTip(){
  showDialog('请输入验证码')
}

$(function(){
  $("#get_code").click(function(){
    var $this = $(this),
        phone = $("#phone").val()

    if(validatePhone(phone)){
      phoneValidateTip()
    }else{
      $.ajax({
        url: 'getcode',
        method: "GET",
        data: {
          phone: phone
        },
        dataType: 'json'
      }).done(function(data) {
        console.log(data.code)
        sendMsgSuccess()
      }).fail(function(data) {
        console.log(data)
        sendMsgFail()
      })
    }
  })

  $("#submit-btn").click(function(){
    var $this = $(this),
        url = '/register',
        method = 'POST',
        phone = $("#phone").val(),
        code = $("#code").val()
        data = {
          phone: phone,
          code: code
        }
    if(code === undefined || code === ''){
      codeEmptyTip()
      return
    }
    if(validatePhone(phone)){
      phoneValidateTip()
    }else{
      $.ajax({
        url: url,
        method: method,
        dataType: "json",
        data: data
      }).done(function(data){
        console.log(data)
        if(data.code !== undefined && data.code){
          window.location.href = '/profile'
        }else{
          showDialog('创建用户失败' + data.msg)
        }
      }).fail(function(err){
        console.log(err)
        showDialog('创建用户失败')
      })
    }
  })
})
</script>
</html>

